import e from"react";import{Field as t,Form as r,FormSpy as n}from"react-final-form";import{FieldArray as a}from"react-final-form-arrays";import o from"final-form-arrays";var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function l(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var u=function(){return(u=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},s=function(t){var r=t.input,n=t.meta;return e.createElement("div",{className:"field",key:"field."+r.name},e.createElement("label",{className:"label"},t.displayName),e.createElement("input",{name:r.name,type:r.type,onChange:r.onChange,onBlur:r.onBlur,onFocus:r.onFocus,className:"textInput",value:r.value}),n.error&&n.touched&&e.createElement("p",null,Array.isArray(n.error)?n.error[n.error.length-1]:n.error))},p={email:function(e){return e.match('/^(([^<>()\\[\\]\\\\.,;:\\s@"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@"]+)*)|(".+"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/')?void 0:"Please enter a valid email"},required:function(e){return e?void 0:"The field cannot be empty"}},m=function(e,t){switch(t||(t=""),typeof e){case"string":return c(e,t);case"object":return Array.isArray(e)?e.map((function(e){switch(typeof e){case"string":return c(e,t);case"function":return f(e,t);default:return}})):void 0;case"function":return f(e,t);default:return}},c=function(e,t){switch(e){case"required":return p.required(t);case"email":return p.email(t)}},f=function(e,t){return e(t)},d={},y={evaluator:function(e,t){return e(d,d.value)},formState:d,updateFormState:function(e){(d=e).form.getFieldState("name")},metaDataEvaluator:function(e,t){return"function"==typeof e?e(t,t.values):e},getFieldState:function(e){var t=d.form.getFieldState(e);return t&&"asd"===t.value?(console.log("here"),"WHEEEWWWW"):"nope"}},h=function(r){function n(){var n=null!==r&&r.apply(this,arguments)||this;return n.render=function(){var r=n.props,a=r.field,o=r.formData;return e.createElement(t,{name:""+a.name,component:n.handleComponent(a),displayName:y.metaDataEvaluator(a.displayName,o),hidden:y.metaDataEvaluator(a.hidden,o),validate:function(e){return a.validators?p.required(e):void 0},size:a.size?y.metaDataEvaluator(a.size,o):10,subscription:n.props.subscription})},n.handleComponent=function(e){return n.props.componentFactory&&e.component&&n.props.componentFactory.hasOwnProperty(e.component)?n.props.componentFactory[e.component]:s},n}return l(n,r),n.prototype.shouldComponentUpdate=function(e,t,r){return!this.props.renderOptions||this.props.renderOptions(this.props.formData,e)},n}(e.Component),v=function(t){var r=t.input,n=t.meta;return e.createElement("div",{className:"dateInput",key:"field."+r.name},e.createElement("label",{className:"label"},t.displayName),e.createElement("input",{name:r.name,type:"date",onChange:function(e){console.log(t.mutators,r.name),r.onChange(e),t.formatting?t.mutators.date(r.name,t.formatting):t.mutators.date(r.name)},onBlur:r.onBlur,onFocus:r.onFocus,className:"date"}),n.error&&n.touched&&e.createElement("p",null,Array.isArray(n.error)?n.error[n.error.length-1]:n.error))},E=["string","array","entity","document","group","date"],N=function(e,t,r){r.changeValue(t,e[0],(function(t){return function(t){var r=t.split("-"),n=new Date(parseInt(r[0]),parseInt(r[1])-1,parseInt(r[2]));if(!e[1])return n.toDateString();switch(e[1]){case"epoch":return n.getTime();case"UTC":return n.toUTCString();case"ISO":return n.toISOString();default:return n.getTime()}}(t)}))},g=function(i){function c(l){var c=i.call(this,l)||this;return c.handleSubmit=function(e){c.props.onSubmit(e)},c.checkSchema=function(){for(var e=!1,t=0,r=c.props.schema.entities;t<r.length;t++){r[t].name===c.props.entityName&&(e=!0)}if(!e)throw Error("The given schema doesn't contain any entity with the given entityName")},c.render=function(){try{var n=c.props.schema.entities;return c.checkSchema(),e.createElement("div",{className:"container",key:"container"},e.createElement(r,{onSubmit:c.handleSubmit,initialValues:c.props.initialValues?c.props.initialValues:void 0,subscription:c.props.subscription?c.props.subscription:void 0,validateOnBlur:!0,mutators:u({},o,{date:N}),render:function(r){return c.formProps=r,e.createElement("form",{onSubmit:r.handleSubmit},n.map((function(e){return e.name===c.props.entityName?c.entityEvaluator(e):void 0})),e.createElement(t,{name:"bottomBar",component:c.props.bottomBar,key:"bottomBar"}))}}))}catch(t){return console.error(t),e.createElement("h1",null,"Oops! Seems like there was an Error, please check the provided Schema")}},c.entityEvaluator=function(e,t){if(!e.layouts)return c.fieldEvaluator(e.fields);var r=e.fields,n=e.layouts;if(!c.props.layoutName)throw Error("When using layouts please specify the property layoutName");if(!Array.isArray(n)){if(n.hasOwnProperty(c.props.layoutName))return n[c.props.layoutName].orientation?c.handleOrientation(n[c.props.layoutName].orientation,n,r,n[c.props.layoutName].name):c.layoutEvaluator(c.props.layoutName,n,r);throw Error("The provided prop layoutName doesn't match with any layout name given the schema")}for(var a=!1,o=0,i=n;o<i.length;o++){var l=i[o];if(l.name===c.props.layoutName)return a=!0,l.orientation?c.handleOrientation(l.orientation,n,r,l.name):c.layoutEvaluator(l.name,n,r);if(!a)throw Error("The provided prop layoutName doesn't match with any layout name given the schema")}},c.layoutEvaluator=function(e,t,r){if(!Array.isArray(t))return t[e].groups?c.fieldEvaluator(r,t[e].fields,t[e].groups):c.fieldEvaluator(r,t[e].fields);for(var n=0,a=t;n<a.length;n++){var o=a[n];if(o.name===c.props.layoutName)return o.groups?c.fieldEvaluator(r,o.fields,o.groups):c.fieldEvaluator(r,o.fields)}},c.fieldEvaluator=function(t,r,n){var a=function(r,a){if(r.group&&n){if(n.hasOwnProperty(r.group))return e.createElement("label",null,r.displayName,c.groupEvaluator(n[r.group],t,a));throw Error("The given group name doesn't exist")}return c.fieldRenderer(r,a)};if(!r){if(Array.isArray(t))return t.map((function(e,r){try{return c.fieldRenderer(e,r)}finally{r===t.length-1&&c.fieldNameStack.pop()}}));var o=[];for(var i in t){d=u({name:i},t[i]);o.push(d)}return o.map((function(e,t){try{return a(e,t)}finally{t===o.length-1&&c.fieldNameStack.pop()}}))}if(!Array.isArray(r)){if(Array.isArray(t))return t.map((function(e,n){if(e.name&&r.hasOwnProperty(e.name)){var o=u({},r[e.name],e);try{return a(o,n)}finally{n===t.length-1&&c.fieldNameStack.pop()}}}));var l=[];for(var s in r){if(!t.hasOwnProperty(s))return;d=u({},t[s],r[s],{name:s});l.push(d)}return l.map((function(e,t){try{return a(e,t)}finally{t===l.length-1&&c.fieldNameStack.pop()}}))}var p=[];if(Array.isArray(t)){for(var m in r)for(var f in t)if(r[m].name===t[f].name){var d=u({},r[m],t[f]);p.push(d)}if(p.length>0)return p.map((function(e,t){try{return a(e,t)}finally{t===p.length-1&&c.fieldNameStack.pop()}}))}else{var y=[];for(var s in r){if(!t.hasOwnProperty(s))return;var d=u({},t[s],r[s],{name:s});return y.push(d),y.map((function(e,t){try{return a(e,t)}finally{t===y.length-1&&c.fieldNameStack.pop()}}))}}},c.groupEvaluator=function(t,r,n){return t.orientation?"vertical"===t.orientation?e.createElement("div",{className:"verticalGroup",key:t.orientation+"."+n},c.fieldEvaluator(r,t.fields)):"horizontal"===t.orientation?e.createElement("div",{className:"horizontalGroup",key:t.orientation+"."+n},c.fieldEvaluator(r,t.fields)):void 0:e.createElement("div",{className:"verticalGroup",key:"verticalGroup."+n},c.fieldEvaluator(r,t.fields))},c.handleOrientation=function(t,r,n,a){if(a){if("vertical"===t)return e.createElement("div",{className:"verticalLayout",key:""+c.fieldNameStack.join()},c.layoutEvaluator(a,r,n));if("horizontal"===t)return e.createElement("div",{className:"horizontalLayout",key:""+c.fieldNameStack.join()},c.layoutEvaluator(a,r,n))}},c.fieldRenderer=function(r,o){var i="";if(i=0!==c.fieldNameStack.length?c.fieldNameStack.join(".")+"."+r.name:r.name,!E.includes(r.type))throw Error('The provided field type for the field name "'+r.name+'" is not supported');if(c.fieldPropertyCheck(r))return r.name=i,e.createElement(n,{render:function(t){return e.createElement("div",{className:"fieldContainer",style:c.buildCustomStyle(r),key:i},e.createElement(h,{field:r,formData:t,renderOptions:c.props.renderOption?c.props.renderOption:void 0,subscription:c.fieldSubscriptionEvaluator(r),componentFactory:c.props.componentFactory?c.props.componentFactory:void 0,key:i}))}});if(c.props.componentFactory&&c.props.componentFactory.hasOwnProperty(r.component))return e.createElement("div",{className:"fieldContainer",style:c.buildCustomStyle(r),key:i},e.createElement(t,{name:i,component:c.props.componentFactory[r.component],key:i,displayName:r.displayName,validate:function(e){return r.validators?p.required(e):void 0},enum:r.enum?r.enum:[],subscription:c.fieldSubscriptionEvaluator(r),hidden:r.hidden?r.hidden:void 0}));if(r.component&&c.props.componentFactory&&!c.props.componentFactory.hasOwnProperty(r.component))throw Error("The given component in the field with name '"+r.name+"' doesn't exist in given componentFactory");if("string"===r.type||"number"===r.type)return e.createElement("div",{className:"fieldContainer",style:c.buildCustomStyle(r),key:i},e.createElement(t,{name:i,key:i,displayName:r.displayName,component:s,validate:function(e){return r.validators?m(r.validators,e):void 0},type:r.type,subscription:c.fieldSubscriptionEvaluator(r),placeholder:r.displayName,hidden:r.hidden?r.hidden:void 0}));if("entity"===r.type){if(!r.entityName)throw Error("There should be an entityName for schema for a field of type entity");var l=!1;c.fieldNameStack.push(r.name);for(var u=0,f=c.props.schema.entities;u<f.length;u++){var d=f[u];if(d.name===r.entityName)return c.currentEntity=d,l=!0,e.createElement("label",null,r.displayName,c.entityEvaluator(d))}if(!l)throw Error("The given entityName of the field doesn't match with the entities in the schema")}else{if("date"===r.type)return e.createElement("div",{className:"fieldContainer",style:c.buildCustomStyle(r),key:i},e.createElement(t,{name:i,key:i,displayName:r.displayName,component:r.component?r.component:v,validate:function(e){return r.validators?m(r.validators,e):void 0},type:r.type,subscription:c.fieldSubscriptionEvaluator(r),placeholder:r.displayName,hidden:r.hidden?r.hidden:void 0,formatting:r.format?r.format:void 0,mutators:c.formProps.form.mutators}));if("array"===r.type){if(!r.arrayType)throw Error("There should be an arrayType for a field of type array");if(!r.entityName)throw Error("There should be an entityName for schema for a field of type array");if("entity"!==r.arrayType)throw Error("Currently only arrayType of entity is supported");return e.createElement("div",{className:"array",style:c.buildCustomStyle(r),key:i},e.createElement("label",null,r.displayName),e.createElement(a,{name:i,render:function(e){return e.fields.map((function(t){try{return c.fieldNameStack.push(t),c.handleArray(e,r.entityName,t)}finally{c.fieldNameStack.pop()}}))}}),e.createElement("button",{type:"button",onClick:function(){return c.formProps.form.mutators.push(i,void 0)}},r.addText?r.addText:"Add +"))}}},c.handleArray=function(e,t,r){for(var n=0,a=c.props.schema.entities;n<a.length;n++){var o=a[n];o.name===t&&(c.currentEntity=o)}return c.entityEvaluator(c.currentEntity,r)},c.fieldPropertyCheck=function(e){for(var t in e)if("function"==typeof e[t])return!0;return!1},c.fieldSubscriptionEvaluator=function(e){return e.subscription?e.subscription:c.props.allFieldsSubscription?c.props.allFieldsSubscription:void 0},c.buildCustomStyle=function(e){var t,r={};if(e.hidden&&Object.assign(r,{display:"hidden"}),e.size&&"function"!=typeof e.size){var n=(t=10*e.size)/4;"array"!==e.type?Object.assign(r,{flex:e.size,maxWidth:t+"vw",flexWrap:"wrap"}):Object.assign(r,{flex:e.size,maxWidth:t+"vw",flexWrap:"wrap",minWidth:n+"vw",width:t+"vw"})}else{n=(t=100)/4;Object.assign(r,{flex:t/10,maxWidth:t+"vw",flexWrap:"wrap",minWidth:n+"vw",width:t+"vw"})}return r},c.previousEntity="",c.isArray=!1,c.currentEntity={},c.formProps={},c.nested=!1,c.fieldNameStack=[],c}return l(c,i),c}(e.Component);export default g;
